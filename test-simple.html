<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Registration Test - AgriTrace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-seedling me-2"></i>AgriTrace
            </a>
            <button class="btn btn-outline-light ms-auto" id="connectWalletBtn">
                <i class="fas fa-wallet me-1"></i>Connect Wallet
            </button>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="hero-section text-center py-5">
            <h1 class="display-4 mb-4">Simple Registration Test</h1>
            <p class="lead">Test user registration without complex dependencies</p>
        </div>

        <div class="row mt-5">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Connection Status</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Wallet Connected:</strong> <span id="walletStatus">No</span></p>
                        <p><strong>Network:</strong> <span id="networkStatus">Unknown</span></p>
                        <p><strong>Account:</strong> <span id="accountStatus">None</span></p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Registration Status</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>User Registered:</strong> <span id="userStatus">Unknown</span></p>
                        <p><strong>Current User:</strong> <span id="currentUser">None</span></p>
                        <p><strong>User Role:</strong> <span id="userRole">None</span></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>Actions</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-primary me-2" onclick="connectWallet()">
                        <i class="fas fa-link me-1"></i>Connect Wallet
                    </button>
                    <button class="btn btn-info me-2" onclick="checkRegistration()">
                        <i class="fas fa-user-check me-1"></i>Check Registration
                    </button>
                    <button class="btn btn-success me-2" onclick="showRegistrationPrompt()">
                        <i class="fas fa-user-plus me-1"></i>Show Registration
                    </button>
                    <button class="btn btn-warning" onclick="clearLog()">
                        <i class="fas fa-trash me-1"></i>Clear Log
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>Console Output</h5>
                </div>
                <div class="card-body">
                    <div id="consoleOutput" class="bg-dark text-light p-3" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong class="me-auto">AgriTrace</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                <!-- Toast message will be inserted here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/web3.min.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/blockchain.js"></script>
    
    <script>
        let blockchainService = null;
        let web3 = null;
        let account = null;
        let contract = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const output = document.getElementById('consoleOutput');
            const colors = {
                'info': '#00ff00',
                'error': '#ff4444',
                'success': '#44ff44',
                'warning': '#ffaa00'
            };
            const color = colors[type] || '#ffffff';
            output.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }
        
        function showToast(message, type = 'info') {
            const toastEl = document.getElementById('toast');
            const toastBody = toastEl.querySelector('.toast-body');
            const toastIcon = toastEl.querySelector('i');
            
            toastBody.textContent = message;
            
            const icons = {
                'success': 'fas fa-check-circle text-success',
                'error': 'fas fa-exclamation-circle text-danger',
                'warning': 'fas fa-exclamation-triangle text-warning',
                'info': 'fas fa-info-circle text-primary'
            };
            
            toastIcon.className = icons[type] || icons['info'];
            
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
        
        function updateStatus() {
            // Update wallet status
            if (account) {
                document.getElementById('walletStatus').textContent = 'Yes';
                document.getElementById('walletStatus').className = 'text-success';
                document.getElementById('accountStatus').textContent = account.substring(0, 10) + '...';
            } else {
                document.getElementById('walletStatus').textContent = 'No';
                document.getElementById('walletStatus').className = 'text-danger';
                document.getElementById('accountStatus').textContent = 'None';
            }
        }
        
        async function connectWallet() {
            try {
                log('Connecting wallet...', 'info');
                
                if (!window.ethereum) {
                    throw new Error('MetaMask is not installed');
                }
                
                // Request account access
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                account = accounts[0];
                web3 = new Web3(window.ethereum);
                
                // Check network
                const networkId = await web3.eth.net.getId();
                const chainId = await web3.eth.getChainId();
                
                log(`Connected to account: ${account}`, 'success');
                log(`Network ID: ${networkId}, Chain ID: ${chainId}`, 'info');
                
                if (networkId !== 97) {
                    log('Warning: Not connected to BSC Testnet (97)', 'warning');
                    document.getElementById('networkStatus').textContent = `Wrong Network (${networkId})`;
                    document.getElementById('networkStatus').className = 'text-warning';
                } else {
                    log('Connected to BSC Testnet', 'success');
                    document.getElementById('networkStatus').textContent = 'BSC Testnet';
                    document.getElementById('networkStatus').className = 'text-success';
                }
                
                // Initialize blockchain service
                blockchainService = new BlockchainService();
                await blockchainService.connectWallet();
                
                updateStatus();
                showToast('Wallet connected successfully', 'success');
                
            } catch (error) {
                log(`Error connecting wallet: ${error.message}`, 'error');
                showToast(`Connection failed: ${error.message}`, 'error');
            }
        }
        
        async function checkRegistration() {
            try {
                log('Checking user registration...', 'info');
                
                if (!blockchainService) {
                    log('Please connect wallet first', 'warning');
                    return;
                }
                
                const isRegistered = await blockchainService.isUserRegistered();
                log(`User registered: ${isRegistered}`, isRegistered ? 'success' : 'warning');
                
                if (isRegistered) {
                    const user = await blockchainService.getCurrentUser();
                    if (user) {
                        log(`User info: ${JSON.stringify(user, null, 2)}`, 'info');
                        document.getElementById('userStatus').textContent = 'Yes';
                        document.getElementById('userStatus').className = 'text-success';
                        document.getElementById('currentUser').textContent = user.companyName;
                        document.getElementById('userRole').textContent = user.role;
                    } else {
                        log('User data not found', 'warning');
                        document.getElementById('userStatus').textContent = 'Unknown';
                        document.getElementById('userStatus').className = 'text-warning';
                    }
                } else {
                    log('User not registered', 'warning');
                    document.getElementById('userStatus').textContent = 'No';
                    document.getElementById('userStatus').className = 'text-danger';
                    document.getElementById('currentUser').textContent = 'Not registered';
                    document.getElementById('userRole').textContent = 'None';
                }
                
            } catch (error) {
                log(`Error checking registration: ${error.message}`, 'error');
                showToast(`Registration check failed: ${error.message}`, 'error');
            }
        }
        
        function showRegistrationPrompt() {
            try {
                log('Showing registration prompt...', 'info');
                
                // Remove existing prompt
                const existingPrompt = document.querySelector('.registration-prompt');
                if (existingPrompt) {
                    existingPrompt.remove();
                }
                
                // Create registration prompt
                const registrationDiv = document.createElement('div');
                registrationDiv.className = 'alert alert-info mt-3 registration-prompt';
                registrationDiv.innerHTML = `
                    <h6><i class="fas fa-user-plus me-2"></i>Welcome to AgriTrace!</h6>
                    <p>You need to register to use the system. Please choose your role:</p>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-success btn-sm" onclick="registerUser('FARMER')">
                            <i class="fas fa-seedling me-1"></i>Farmer
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="registerUser('PROCESSOR')">
                            <i class="fas fa-industry me-1"></i>Processor
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="registerUser('TRANSPORTER')">
                            <i class="fas fa-truck me-1"></i>Transporter
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="registerUser('WAREHOUSE')">
                            <i class="fas fa-warehouse me-1"></i>Warehouse
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="registerUser('RETAILER')">
                            <i class="fas fa-store me-1"></i>Retailer
                        </button>
                    </div>
                `;
                
                // Insert after hero section
                const heroSection = document.querySelector('.hero-section');
                if (heroSection) {
                    heroSection.insertAdjacentElement('afterend', registrationDiv);
                    log('Registration prompt displayed', 'success');
                    showToast('Registration prompt is now visible', 'info');
                } else {
                    log('Could not find hero section to insert prompt', 'error');
                }
                
            } catch (error) {
                log(`Error showing registration prompt: ${error.message}`, 'error');
            }
        }
        
        async function registerUser(role) {
            try {
                log(`Registering user with role: ${role}`, 'info');
                
                if (!blockchainService) {
                    log('Please connect wallet first', 'warning');
                    return;
                }
                
                const companyName = prompt(`Please enter your company name for role: ${role}`);
                if (!companyName || companyName.trim() === '') {
                    log('Company name is required', 'warning');
                    showToast('Company name is required', 'warning');
                    return;
                }
                
                log(`Registering with company: ${companyName}`, 'info');
                showToast('Sending registration transaction...', 'info');
                
                const tx = await blockchainService.registerUser(role, companyName.trim());
                log(`Registration transaction: ${tx.transactionHash}`, 'success');
                
                showToast('Registration successful! Please wait for admin verification.', 'success');
                
                // Remove registration prompt
                const registrationPrompt = document.querySelector('.registration-prompt');
                if (registrationPrompt) {
                    registrationPrompt.remove();
                }
                
                // Wait and check registration
                setTimeout(async () => {
                    log('Checking registration after transaction...', 'info');
                    await checkRegistration();
                }, 3000);
                
            } catch (error) {
                log(`Error registering user: ${error.message}`, 'error');
                showToast(`Registration failed: ${error.message}`, 'error');
            }
        }
        
        function clearLog() {
            document.getElementById('consoleOutput').innerHTML = '';
            log('Log cleared', 'info');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Simple registration test initialized', 'info');
            log('Click "Connect Wallet" to start', 'info');
        });
        
        // Connect wallet button
        document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
    </script>
</body>
</html>
