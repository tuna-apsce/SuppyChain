<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Batch IDs - AgriTrace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-seedling me-2"></i>Test Batch IDs
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-bug me-2"></i>Debug Batch IDs Issue</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-primary" onclick="testConnection()">
                                <i class="fas fa-plug me-1"></i>Test Connection
                            </button>
                            <button class="btn btn-info ms-2" onclick="testGetAllBatchIds()">
                                <i class="fas fa-list me-1"></i>Test getAllBatchIds()
                            </button>
                            <button class="btn btn-success ms-2" onclick="testGetProductCount()">
                                <i class="fas fa-calculator me-1"></i>Test getProductCount()
                            </button>
                        </div>
                        
                        <div id="results" class="mt-3">
                            <!-- Results will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/web3.min.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/blockchain.js"></script>
    
    <script>
        let blockchainService = null;
        
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultClass = type === 'success' ? 'alert-success' : 
                               type === 'error' ? 'alert-danger' : 
                               type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `alert ${resultClass} alert-dismissible fade show`;
            resultDiv.innerHTML = `
                <div>${message}</div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            resultsDiv.appendChild(resultDiv);
        }
        
        async function testConnection() {
            try {
                addResult('Testing blockchain connection...', 'info');
                
                if (!blockchainService) {
                    blockchainService = new BlockchainService();
                }
                
                await blockchainService.connectWallet();
                addResult(`✅ Connected successfully! Account: ${blockchainService.getCurrentAccount()}`, 'success');
                
                // Test network health
                const health = await blockchainService.checkNetworkHealth();
                addResult(`✅ Network health: ${JSON.stringify(health, null, 2)}`, 'success');
                
            } catch (error) {
                addResult(`❌ Connection failed: ${error.message}`, 'error');
                console.error('Connection error:', error);
            }
        }
        
        async function testGetAllBatchIds() {
            try {
                addResult('Testing getAllBatchIds()...', 'info');
                
                if (!blockchainService || !blockchainService.isConnected()) {
                    addResult('❌ Please connect wallet first', 'warning');
                    return;
                }
                
                const batchIds = await blockchainService.getAllBatchIds();
                addResult(`✅ getAllBatchIds() successful! Result: ${JSON.stringify(batchIds, null, 2)}`, 'success');
                
                if (batchIds.length === 0) {
                    addResult('ℹ️ No batch IDs found - contract is empty or no products created yet', 'info');
                }
                
            } catch (error) {
                addResult(`❌ getAllBatchIds() failed: ${error.message}`, 'error');
                console.error('getAllBatchIds error:', error);
                
                if (error.message.includes('missing trie node')) {
                    addResult('🔍 "missing trie node" error - this usually means the contract state is corrupted or RPC issue', 'warning');
                }
            }
        }
        
        async function testGetProductCount() {
            try {
                addResult('Testing getProductCount()...', 'info');
                
                if (!blockchainService || !blockchainService.isConnected()) {
                    addResult('❌ Please connect wallet first', 'warning');
                    return;
                }
                
                const count = await blockchainService.getProductCount();
                addResult(`✅ getProductCount() successful! Count: ${count}`, 'success');
                
            } catch (error) {
                addResult(`❌ getProductCount() failed: ${error.message}`, 'error');
                console.error('getProductCount error:', error);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addResult('Test page loaded. Click "Test Connection" to start.', 'info');
        });
    </script>
</body>
</html>
