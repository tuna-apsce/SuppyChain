<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Creation Test - AgriTrace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-seedling me-2"></i>Product Creation Test
            </a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-box me-2"></i>Test Product Creation</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-primary" onclick="testConnection()">
                                <i class="fas fa-plug me-1"></i>Test Connection
                            </button>
                            <button class="btn btn-info ms-2" onclick="checkUserStatus()">
                                <i class="fas fa-user-check me-1"></i>Check User Status
                            </button>
                            <button class="btn btn-success ms-2" onclick="createTestProduct()">
                                <i class="fas fa-plus me-1"></i>Create Test Product
                            </button>
                        </div>
                        
                        <div id="results" class="mt-3">
                            <!-- Results will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/web3.min.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/blockchain.js"></script>
    
    <script>
        let blockchainService = null;
        
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultClass = type === 'success' ? 'alert-success' : 
                               type === 'error' ? 'alert-danger' : 
                               type === 'warning' ? 'alert-warning' : 'alert-info';
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `alert ${resultClass} alert-dismissible fade show`;
            resultDiv.innerHTML = `
                <div>${message}</div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            resultsDiv.appendChild(resultDiv);
        }
        
        async function testConnection() {
            try {
                addResult('Testing blockchain connection...', 'info');
                
                if (!blockchainService) {
                    blockchainService = new BlockchainService();
                }
                
                await blockchainService.connectWallet();
                const account = blockchainService.getCurrentAccount();
                addResult(`‚úÖ Connected successfully! Account: ${account}`, 'success');
                
                // Test network health
                const health = await blockchainService.checkNetworkHealth();
                addResult(`‚úÖ Network health: ${JSON.stringify(health, null, 2)}`, 'success');
                
            } catch (error) {
                addResult(`‚ùå Connection failed: ${error.message}`, 'error');
                console.error('Connection error:', error);
            }
        }
        
        async function checkUserStatus() {
            try {
                addResult('Checking user status...', 'info');
                
                if (!blockchainService || !blockchainService.isConnected()) {
                    addResult('‚ùå Please connect wallet first', 'warning');
                    return;
                }
                
                const user = await blockchainService.getCurrentUser();
                if (user) {
                    addResult(`‚úÖ User found:`, 'success');
                    addResult(`üìã User Details:<br>` +
                        `‚Ä¢ Address: ${user.userAddress}<br>` +
                        `‚Ä¢ Role: ${user.role}<br>` +
                        `‚Ä¢ Company: ${user.companyName}<br>` +
                        `‚Ä¢ Verified: ${user.isVerified ? 'Yes' : 'No'}<br>` +
                        `‚Ä¢ Active: ${user.isActive ? 'Yes' : 'No'}`, 'info');
                    
                    if (user.role !== '0') {
                        addResult('‚ö†Ô∏è Warning: User role is not FARMER (0)', 'warning');
                    }
                    
                    if (!user.isVerified) {
                        addResult('‚ö†Ô∏è Warning: User is not verified', 'warning');
                    }
                    
                    if (!user.isActive) {
                        addResult('‚ö†Ô∏è Warning: User is not active', 'warning');
                    }
                } else {
                    addResult('‚ùå User not found - please register first', 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå User status check failed: ${error.message}`, 'error');
                console.error('User status error:', error);
            }
        }
        
        async function createTestProduct() {
            try {
                addResult('Creating test product...', 'info');
                
                if (!blockchainService || !blockchainService.isConnected()) {
                    addResult('‚ùå Please connect wallet first', 'warning');
                    return;
                }
                
                // Test product data
                const productData = {
                    batchId: 'TEST-' + Date.now(),
                    productName: 'Test Product',
                    category: 'Vegetables',
                    origin: 'Test Farm',
                    harvestDate: new Date(),
                    expiryDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days from now
                    quantity: 100,
                    unit: 'kg',
                    ipfsHash: ''
                };
                
                addResult(`üìã Test Product Data:<br>` +
                    `‚Ä¢ Batch ID: ${productData.batchId}<br>` +
                    `‚Ä¢ Name: ${productData.productName}<br>` +
                    `‚Ä¢ Category: ${productData.category}<br>` +
                    `‚Ä¢ Origin: ${productData.origin}<br>` +
                    `‚Ä¢ Quantity: ${productData.quantity} ${productData.unit}`, 'info');
                
                // Estimate gas first
                addResult('Estimating gas...', 'info');
                const gasEstimate = await blockchainService.contract.methods.createProduct(
                    productData.batchId,
                    productData.productName,
                    productData.category,
                    productData.origin,
                    Math.floor(productData.harvestDate.getTime() / 1000),
                    Math.floor(productData.expiryDate.getTime() / 1000),
                    productData.quantity,
                    productData.unit,
                    productData.ipfsHash
                ).estimateGas({ from: blockchainService.getCurrentAccount() });
                
                addResult(`‚úÖ Gas estimate: ${gasEstimate}`, 'success');
                const gasWithBuffer = Math.floor(gasEstimate * 1.2);
                addResult(`üìä Gas with 20% buffer: ${gasWithBuffer}`, 'info');
                
                // Create product
                addResult('Creating product on blockchain...', 'info');
                const tx = await blockchainService.createProduct(productData);
                
                addResult(`‚úÖ Product created successfully!`, 'success');
                addResult(`üìã Transaction Details:<br>` +
                    `‚Ä¢ Hash: ${tx.transactionHash}<br>` +
                    `‚Ä¢ Block: ${tx.blockNumber}<br>` +
                    `‚Ä¢ Gas Used: ${tx.gasUsed}`, 'info');
                
            } catch (error) {
                addResult(`‚ùå Product creation failed: ${error.message}`, 'error');
                console.error('Product creation error:', error);
                
                if (error.message.includes('Transaction has been reverted')) {
                    addResult('üí° This usually means:<br>' +
                        '‚Ä¢ User is not verified<br>' +
                        '‚Ä¢ User role is not FARMER<br>' +
                        '‚Ä¢ User is not active<br>' +
                        '‚Ä¢ Gas limit too low<br>' +
                        '‚Ä¢ Invalid product data', 'warning');
                }
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addResult('Product creation test page loaded', 'info');
        });
    </script>
</body>
</html>
