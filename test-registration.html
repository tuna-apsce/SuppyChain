<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Test - AgriTrace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-seedling me-2"></i>AgriTrace
            </a>
            <button class="btn btn-outline-light ms-auto" id="connectWalletBtn">
                <i class="fas fa-wallet me-1"></i>Connect Wallet
            </button>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="hero-section text-center py-5">
            <h1 class="display-4 mb-4">AgriTrace Registration Test</h1>
            <p class="lead">Test user registration flow</p>
        </div>

        <div class="row mt-5">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Current Status</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Wallet Connected:</strong> <span id="walletStatus">No</span></p>
                        <p><strong>User Registered:</strong> <span id="userStatus">Unknown</span></p>
                        <p><strong>Current User:</strong> <span id="currentUser">None</span></p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Test Actions</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary mb-2" onclick="testConnection()">
                            <i class="fas fa-link me-1"></i>Test Connection
                        </button>
                        <br>
                        <button class="btn btn-info mb-2" onclick="checkUserRegistration()">
                            <i class="fas fa-user-check me-1"></i>Check Registration
                        </button>
                        <br>
                        <button class="btn btn-success mb-2" onclick="triggerRegistrationPrompt()">
                            <i class="fas fa-user-plus me-1"></i>Show Registration Prompt
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>Console Output</h5>
                </div>
                <div class="card-body">
                    <div id="consoleOutput" class="bg-dark text-light p-3" style="height: 200px; overflow-y: auto; font-family: monospace;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong class="me-auto">AgriTrace</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                <!-- Toast message will be inserted here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/web3.min.js"></script>
    <script src="assets/js/utils.js"></script>
    <script src="assets/js/blockchain.js"></script>
    <script src="assets/js/ipfs.js"></script>
    <script src="assets/js/app.js"></script>
    
    <script>
        let app = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const output = document.getElementById('consoleOutput');
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'white';
            output.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }
        
        async function testConnection() {
            try {
                log('Testing connection...', 'info');
                if (!app || !app.blockchainService.isConnected()) {
                    log('Please connect wallet first', 'warning');
                    return;
                }
                
                const networkHealth = await app.blockchainService.checkNetworkHealth();
                log(`Network health: ${JSON.stringify(networkHealth)}`, 'info');
                
                if (networkHealth.healthy) {
                    log('Connection test successful!', 'success');
                    updateStatus();
                } else {
                    log('Connection test failed!', 'error');
                }
                
            } catch (error) {
                log(`Connection test error: ${error.message}`, 'error');
            }
        }
        
        async function checkUserRegistration() {
            try {
                log('Checking user registration...', 'info');
                if (!app || !app.blockchainService.isConnected()) {
                    log('Please connect wallet first', 'warning');
                    return;
                }
                
                const isRegistered = await app.blockchainService.isUserRegistered();
                log(`User registered: ${isRegistered}`, isRegistered ? 'success' : 'warning');
                
                if (isRegistered) {
                    const user = await app.blockchainService.getCurrentUser();
                    log(`User info: ${JSON.stringify(user, null, 2)}`, 'info');
                } else {
                    log('User not registered - showing registration prompt', 'info');
                }
                
                updateStatus();
                
            } catch (error) {
                log(`Registration check error: ${error.message}`, 'error');
            }
        }
        
        function triggerRegistrationPrompt() {
            try {
                log('Triggering registration prompt...', 'info');
                if (!app) {
                    log('App not initialized', 'error');
                    return;
                }
                
                app.showRegistrationPrompt();
                log('Registration prompt should be visible now', 'success');
                
            } catch (error) {
                log(`Error triggering registration prompt: ${error.message}`, 'error');
            }
        }
        
        function updateStatus() {
            if (app && app.blockchainService.isConnected()) {
                document.getElementById('walletStatus').textContent = 'Yes';
                document.getElementById('walletStatus').className = 'text-success';
                
                if (app.currentUser) {
                    document.getElementById('userStatus').textContent = 'Yes';
                    document.getElementById('userStatus').className = 'text-success';
                    document.getElementById('currentUser').textContent = `${app.currentUser.role} - ${app.currentUser.companyName}`;
                } else {
                    document.getElementById('userStatus').textContent = 'No';
                    document.getElementById('userStatus').className = 'text-warning';
                    document.getElementById('currentUser').textContent = 'Not registered';
                }
            } else {
                document.getElementById('walletStatus').textContent = 'No';
                document.getElementById('walletStatus').className = 'text-danger';
                document.getElementById('userStatus').textContent = 'Unknown';
                document.getElementById('userStatus').className = 'text-muted';
                document.getElementById('currentUser').textContent = 'Not connected';
            }
        }
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            log('Initializing AgriTrace app...', 'info');
            app = new AgriTraceApp();
            
            // Override connectWallet to update status
            const originalConnectWallet = app.connectWallet;
            app.connectWallet = async function() {
                await originalConnectWallet.call(this);
                updateStatus();
                log('Wallet connection completed', 'success');
            };
            
            // Override loadUserInfo to update status
            const originalLoadUserInfo = app.loadUserInfo;
            app.loadUserInfo = async function() {
                await originalLoadUserInfo.call(this);
                updateStatus();
                log('User info loaded', 'info');
            };
            
            log('App initialized successfully', 'success');
        });
        
        // Connect wallet button
        document.getElementById('connectWalletBtn').addEventListener('click', async () => {
            try {
                await app.connectWallet();
            } catch (error) {
                log(`Error connecting wallet: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>
